# storj-bootstrap

Orchestrate a local DragonflyDB instance and JuiceFS on Storj S3-compatible storage.

## Features

- Automated DragonflyDB startup with optional password  
- JuiceFS volume check, format, and metadata restore  
- Backup/restore from Storj S3 bucket  
- Dockerized for local or Fly.io deployment  
- Persistent storage via Fly.io volumes  

## Prerequisites

- Docker (for local)  
- Fly.io account & `flyctl`  
- Storj S3-compatible credentials  
- [JuiceFS](https://juicefs.com) (client installed in container)  
- AWS CLI (installed in container)  

## Environment Variables

| Variable               | Description                                                  |
|------------------------|--------------------------------------------------------------|
| `STORJ_ACCESS_KEY`     | Storj S3 access key                                          |
| `STORJ_SECRET_KEY`     | Storj S3 secret key                                          |
| `STORJ_BUCKET_URL`     | Storj bucket URL (e.g. https://endpoint/bucket)              |
| `STORJ_DEFAULT_REGION` | Default region (e.g. us-east-1)                             |
| `DRAGONFLY_PASSWORD`   | (Optional) DragonflyDB password; autogenerated if missing    |

## Local Docker Usage

```bash
# Build image
docker build -t storj-bootstrap .

# Run container
docker run -d \
  --name storj-bootstrap \
  -e STORJ_ACCESS_KEY \
  -e STORJ_SECRET_KEY \
  -e STORJ_BUCKET_URL \
  -e STORJ_DEFAULT_REGION \
  -e DRAGONFLY_PASSWORD \
  -p 6379:6379 \
  storj-bootstrap
```

Logs will indicate DragonflyDB (Redis-compatible) on port 6379 and JuiceFS initialization via [`start.sh`](start.sh:1).

## Fly.io Deployment

```bash
# Launch a new Fly.io app
flyctl launch --name storj-bootstrap

# Set secrets
flyctl secrets set STORJ_ACCESS_KEY=... \
                    STORJ_SECRET_KEY=... \
                    STORJ_BUCKET_URL=... \
                    STORJ_DEFAULT_REGION=...

# Deploy
flyctl deploy
```

The generated [`fly.toml`](fly.toml:1) mounts a volume `dragonfly_data` at `/data` (persisting Redis data) and exposes port 6379.

## Mounting JuiceFS Volume

After initialization, mount the JuiceFS filesystem:

```bash
juicefs mount -d \
  redis://:<DRAGONFLY_PASSWORD>@<app>.fly.dev:6379/0 \
  /mnt/juicefs
```

## Cleanup

```bash
# Docker
docker stop storj-bootstrap && docker rm storj-bootstrap

# Fly.io
flyctl apps destroy storj-bootstrap
```

## Reference

- [`start.sh`](start.sh:1) – Bootstrapping script  
- [`Dockerfile`](Dockerfile:1) – Multi-stage build  
- [`fly.toml`](fly.toml:1) – Fly.io configuration

<!-- EOF -->